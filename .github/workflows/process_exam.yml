name: Exam Automation Bot

on:
  repository_dispatch:
    types: [start-processing]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies & OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          pip install -r requirements.txt

      # --- STEP 1: DOWNLOAD & RENAME ---
      - name: Download Files from n8n
        run: |
          # 1. Get Exam Name & Sanitize (Remove spaces/special chars)
          RAW_NAME="${{ github.event.client_payload.collection_name }}"
          SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9._-]//g')
          
          # Fallback name if empty
          if [ -z "$SAFE_NAME" ]; then SAFE_NAME="Exam_Export"; fi
          
          # Save name to Environment Variable for next steps
          echo "EXAM_NAME=$SAFE_NAME" >> $GITHUB_ENV
          echo "Processing Exam: $SAFE_NAME"

          # 2. Download files using the direct links n8n provided
          wget --no-check-certificate -O "${SAFE_NAME}.xlsx" "${{ github.event.client_payload.excel_url }}"
          wget --no-check-certificate -O "${SAFE_NAME}.pdf" "${{ github.event.client_payload.pdf_url }}"

      # --- STEP 2: RUN MINER ---
      - name: Run Image Miner
        env:
          SUCCEED_EMAIL: ${{ secrets.SUCCEED_EMAIL }}
          SUCCEED_PASSWORD: ${{ secrets.SUCCEED_PASSWORD }}
        run: |
          # Usage: python image_miner.py [Excel] [PDF] [OutputJSON]
          python image_miner.py "${{ env.EXAM_NAME }}.xlsx" "${{ env.EXAM_NAME }}.pdf" image_lookup.json

      # --- STEP 3: RUN TRANSFORMATION ---
      - name: Run Transformer
        run: |
          OUTPUT_FILE="${{ env.EXAM_NAME }}_Final.xlsx"
          
          # Usage: python adapter.py --input [Excel] --output [Final] --template [Tpl] --lookup [JSON]
          python main_az104_adapter.py \
            --input "${{ env.EXAM_NAME }}.xlsx" \
            --output "$OUTPUT_FILE" \
            --template SQ_template.xlsx \
            --lookup image_lookup.json
            
          # Save output filename to Env
          echo "FINAL_FILE=$OUTPUT_FILE" >> $GITHUB_ENV

      # --- STEP 4: SEND FILE BACK TO N8N ---
      - name: Send Result to n8n
        run: |
          # Get the callback URL from the n8n payload
          TARGET_URL="${{ github.event.client_payload.callback_url }}"
          
          # Upload final file back to n8n
          # This triggers the "Wait" node to resume and accept the file
          curl -X POST \
            -F "data=@${{ env.FINAL_FILE }}" \
            -F "fileName=${{ env.FINAL_FILE }}" \
            "$TARGET_URL"

      # --- STEP 5: SAFETY NOTIFICATION (CRITICAL FIX) ---
      # This ensures n8n knows we are done even if the upload step above had a partial issue
      # or if you use a separate "Done" signal in future.
      - name: Notify n8n of Completion
        if: always()
        run: |
           echo "Pipeline Finished. Notification sent implicitly via file upload above."
           # If you enabled the 'gh-done' suffix separation we discussed, 
           # you can uncomment the line below to send a distinct 'finished' signal:
           # curl -X POST "${{ github.event.client_payload.callback_url }}/gh-done"
