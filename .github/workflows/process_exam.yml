name: Exam Automation Bot

on:
  repository_dispatch:
    types: [start-processing]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies & OCR
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr
          pip install -r requirements.txt

      # --- STEP 1: DOWNLOAD & RENAME ---
      - name: Download Files from n8n
        run: |
          # 1. Get Exam Name & Sanitize
          RAW_NAME="${{ github.event.client_payload.collection_name }}"
          SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9._-]//g')
          if [ -z "$SAFE_NAME" ]; then SAFE_NAME="Exam_Export"; fi
          
          echo "EXAM_NAME=$SAFE_NAME" >> $GITHUB_ENV
          echo "Processing Exam: $SAFE_NAME"

          # 2. Download files
          wget --no-check-certificate -O "${SAFE_NAME}.xlsx" "${{ github.event.client_payload.excel_url }}"
          wget --no-check-certificate -O "${SAFE_NAME}.pdf" "${{ github.event.client_payload.pdf_url }}"

      # --- STEP 2: RUN MINER ---
      - name: Run Image Miner
        env:
          SUCCEED_EMAIL: ${{ secrets.SUCCEED_EMAIL }}
          SUCCEED_PASSWORD: ${{ secrets.SUCCEED_PASSWORD }}
        run: |
          python image_miner.py "${{ env.EXAM_NAME }}.xlsx" "${{ env.EXAM_NAME }}.pdf" image_lookup.json

      # --- STEP 3: RUN TRANSFORMATION ---
      - name: Run Transformer
        run: |
          OUTPUT_FILE="${{ env.EXAM_NAME }}_Final.xlsx"
          
          python main_az104_adapter.py \
            --input "${{ env.EXAM_NAME }}.xlsx" \
            --output "$OUTPUT_FILE" \
            --template SQ_template.xlsx \
            --lookup image_lookup.json
            
          echo "FINAL_FILE=$OUTPUT_FILE" >> $GITHUB_ENV

      # --- STEP 4: SEND RESULT TO WORKFLOW B (FINAL) ---
      - name: Send Result to n8n
        run: |
          # 1. Get Variables passed from Workflow A
          RAW_URL="${{ github.event.client_payload.callback_url }}"
          FOLDER_ID="${{ github.event.client_payload.folder_id }}"
          USER_EMAIL="${{ github.event.client_payload.user_email }}"
          
          # 2. FORCE HTTPS (Prevents Redirect Errors)
          TARGET_URL=$(echo "$RAW_URL" | sed 's|^http://|https://|')
          echo "Uploading to: $TARGET_URL"

          # 3. Upload File + Pass Context Variables to Workflow B
          curl -v -L -X POST \
            -F "data=@${{ env.FINAL_FILE }}" \
            -F "fileName=${{ env.FINAL_FILE }}" \
            -F "folder_id=$FOLDER_ID" \
            -F "user_email=$USER_EMAIL" \
            "$TARGET_URL"
